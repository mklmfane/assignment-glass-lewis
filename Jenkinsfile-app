pipeline {
    agent any

    environment {
        REGISTRY_DIR = '/opt/docker-registry'
    }

    stages {
        stage('Checkout Code') {
            steps {
                git url: 'https://github.com/mklmfane/assignment-glass-lewis.git'
            }
        }

        stage('Create Self-Hosted Docker Registry') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'REGISTRY_CREDS', usernameVariable: 'REG_USER', passwordVariable: 'REG_PASS')]) {
                    withEnv(["REG_USER=${REG_USER}", "REG_PASS=${REG_PASS}"]) {
                        sh '''
                            set -eux

                            # Step 1: Copy the nginx.sh script from the repository to the Jenkins workspace
                            echo "Copying the nginx.sh script from the repository"
                            cp docker-registry/nginx.sh /tmp/nginx.sh

                            # Ensure the script is executable
                            sudo chmod +x /tmp/nginx.sh

                            # Step 2: Run the nginx.sh script
                            echo "Running the nginx.sh script with credentials"
                            sudo bash /tmp/nginx.sh

                            # After running the script, print out the status of the registry
                            echo "✅ Docker Registry available at: http://localhost:5000"
                            echo "✅ Registry UI available at: http://localhost:30003"
                        '''
                    }
                }
            }
        }
    }
}
